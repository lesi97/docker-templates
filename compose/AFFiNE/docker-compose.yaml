services:
    postgres:
        image: postgres:16
        container_name: affine-postgres
        restart: unless-stopped
        environment:
            POSTGRES_DB: affine
            POSTGRES_USER: affine
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        volumes:
            - /srv/affine/postgres:/var/lib/postgresql/data
        networks:
            - affine

    redis:
        image: redis:7
        container_name: affine-redis
        restart: unless-stopped
        command: redis-server --save 60 1 --loglevel warning
        volumes:
            - /srv/affine/redis:/data
        networks:
            - affine

    affine:
        image: ghcr.io/toeverything/affine:stable
        container_name: affine
        restart: unless-stopped
        depends_on:
            - postgres
            - redis
        command: >
            sh -c "node ./scripts/self-host-predeploy && node ./dist/main.js"
        environment:
            NODE_ENV: production
            AFFINE_SERVER_PORT: 3010
            AFFINE_SERVER_HTTPS: 'false'
            DATABASE_URL: postgres://affine:${POSTGRES_PASSWORD}@postgres:5432/affine
            REDIS_SERVER_HOST: redis
            REDIS_SERVER_PORT: 6379
            TELEMETRY_ENABLE: 'false'
        volumes:
            - /srv/affine/affine:/root/.affine
        networks:
            - affine
            - proxy
        ports:
            - '3010:3010'

networks:
    affine:
        driver: bridge
    proxy:
        external: true
